function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _classCallCheck(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function _createClass(a,b,c){if(b)_defineProperties(a.prototype,b);if(c)_defineProperties(a,c);return a}define ("mod_opencast/opencast_to_paella_converter",["mod_opencast/paella","mod_opencast/base"],function(a,b){return function(){function c(){_classCallCheck(this,c);this._config=a.player.config.plugins.list["es.upv.paella.opencast.loader"]||{};this._orderTracks=this._config.orderTracks||["presenter/delivery","presenter/preview","presentation/delivery","presentation/preview"]}_createClass(c,[{key:"getFilterStream",value:function getFilterStream(){var a,c=this._config.streams||[];c.some(function(c){return c.filter.system.some(function(d){if("*"==d||b.userAgent.system[d]){a=c;return!0}})});if(!a){a={filter:{system:["*"]},tracks:{flavors:["*/*"],tags:["*"]}}}return a}},{key:"getAudioTagConfig",value:function getAudioTagConfig(){return this._config.audioTag||{"*/*":"*"}}},{key:"getSourceTypeFromTrack",value:function getSourceTypeFromTrack(b){var c=null,d=/^(.*):\/\/.*$/.exec(b.url);if(d){switch(d[1]){case"rtmp":case"rtmps":switch(b.mimetype){case"video/mp4":case"video/ogg":case"video/webm":case"video/x-flv":c="rtmp";break;default:a.debug.log("OpencastToPaellaConverter: MimeType (".concat(b.mimetype,") not supported!"));break;}break;case"http":case"https":switch(b.mimetype){case"video/mp4":case"video/ogg":case"video/webm":c=b.mimetype.split("/")[1];break;case"video/x-flv":c="flv";break;case"application/x-mpegURL":c="hls";break;case"application/dash+xml":c="mpd";break;case"audio/m4a":c="audio";break;default:a.debug.log("OpencastToPaellaConverter: MimeType (".concat(b.mimetype,") not supported!"));break;}break;default:a.debug.log("OpencastToPaellaConverter: Protocol (".concat(d[1],") not supported!"));break;}}return c}},{key:"getStreamSourceFromTrack",value:function getStreamSourceFromTrack(a){var b=[0,0];if(a.video instanceof Object){b=a.video.resolution.split("x")}var c=a.url,d=/^(rtmps?:\/\/[^/]*\/[^/]*)\/(.*)$/.exec(a.url);if(null!==d){var e=d[1],f=d[2];c={server:encodeURIComponent(e),stream:encodeURIComponent(f)}}var g={src:c,isLiveStream:!0===a.live};if("audio/m4a"!=a.mimetype){g.mimetype=a.mimetype;g.res={w:b[0],h:b[1]}}return g}},{key:"getAudioTagFromTrack",value:function getAudioTagFromTrack(a){var c=this.getAudioTagConfig(),d,e=[];if(a.tags&&a.tags.tag){e=a.tags.tag;if(!(e instanceof Array)){e=[e]}}e.some(function(a){if(a.startsWith("audioTag:")){d=a.slice(9);return!0}});if(!d){Object.entries(c).some(function(c){var e=a.type.split("/"),f=c[0].split("/");if(("*"==f[0]||f[0]==e[0])&&("*"==f[1]||f[1]==e[1])){d="*"==c[1]?b.dictionary.currentLanguage():c[1];return!0}})}return d}},{key:"getStreamFromFlavor",value:function getStreamFromFlavor(a,b,c){var d=this,e={sources:{},preview:"",content:b},f=a.mediapackage.media.track,g=a.mediapackage.attachments.attachment;if(!(f instanceof Array)){f=f?[f]:[]}if(!(g instanceof Array)){g=g?[g]:[]}f.forEach(function(a){if(a.type==b+"/"+c){var f=d.getSourceTypeFromTrack(a);if(f){if(!e.sources[f]||!(e.sources[f]instanceof Array)){e.sources[f]=[]}if(a.audio){e.audioTag=d.getAudioTagFromTrack(a)}e.sources[f].push(d.getStreamSourceFromTrack(a));if(a.video){e.type="video"}else if(a.audio){e.type="audio"}}}});var h=parseInt(a.mediapackage.duration/1e3),i={type:"image/jpeg",frames:{},count:0,duration:h,res:{w:320,h:180}},j={type:"image/jpeg",frames:{},count:0,duration:h,res:{w:1280,h:720}};g.forEach(function(a){if(a.type=="".concat(b,"/player+preview")){e.preview=a.url}else if(a.type=="".concat(b,"/segment+preview+hires")){if(/time=T(\d+):(\d+):(\d+)/.test(a.ref)){c=60*(60*parseInt(RegExp.$1))+60*parseInt(RegExp.$2)+parseInt(RegExp.$3);j.frames["frame_"+c]=a.url;j.count=j.count+1}}else if(a.type=="".concat(b,"/segment+preview")){if(/time=T(\d+):(\d+):(\d+)/.test(a.ref)){var c=60*(60*parseInt(RegExp.$1))+60*parseInt(RegExp.$2)+parseInt(RegExp.$3);i.frames["frame_"+c]=a.url;i.count=i.count+1}}});var k=[];if(0<i.count){k.push(i)}if(0<j.count){k.push(j)}if(0<k.length){e.sources.image=k}return e}},{key:"getContentToImport",value:function getContentToImport(a){var b=this.getFilterStream(),c=[],d=a.mediapackage.media.track;if(!(d instanceof Array)){d=[d]}d.forEach(function(a){var d=b.tracks.flavors.some(function(b){var c=b.split("/"),d=a.type.split("/");return("*"==c[0]||c[0]==d[0])&&("*"==c[1]||c[1]==d[1])}),e=!1,f=[];if(a.tags&&a.tags.tag){f=[a.tags.tag];if(!(a.tags.tag instanceof Array)){f=[a.tags.tag]}}e=b.tracks.tags.some(function(a){return"*"==a||f.some(function(b){return a==b})});if(d||e){if(0>c.indexOf(a.type)){c.push(a.type)}}});for(var e=this._orderTracks.length-1,f;0<=e;e--){f=this._orderTracks[e];if(0<c.indexOf(f)){c.splice(c.indexOf(f),1);c.unshift(f)}}return c}},{key:"getStreams",value:function getStreams(a){var b=this,c=[],d=this.getContentToImport(a);d.forEach(function(d){var e=d.split("/"),f=_slicedToArray(e,2),g=f[0],h=f[1],i=b.getStreamFromFlavor(a,g,h);c.push(i)});return c}},{key:"getCaptions",value:function getCaptions(a){var b=[],c=a.mediapackage.attachments.attachment,d=a.mediapackage.metadata.catalog;if(!(c instanceof Array)){c=c?[c]:[]}if(!(d instanceof Array)){d=d?[d]:[]}c.forEach(function(a){try{var c=/^captions\/([^+]+)(\+(.+))?/g.exec(a.type);if(c){var d=c[1],e=c[3];if(!e&&a.tags&&a.tags.tag){if(!(a.tags.tag instanceof Array)){a.tags.tag=[a.tags.tag]}a.tags.tag.forEach(function(a){if(a.startsWith("lang:")){var b=a.split(":");e=b[1]}})}var f=e||"unknown language";b.push({id:a.id,lang:e,text:f,url:a.url,format:d})}}catch(a){}});d.forEach(function(a){try{if("captions/timedtext"==a.type){var c;if(a.tags&&a.tags.tag){if(!(a.tags.tag instanceof Array)){a.tags.tag=[a.tags.tag]}a.tags.tag.forEach(function(a){if(a.startsWith("lang:")){var b=a.split(":");c=b[1]}})}var d=c||"unknown language";b.push({id:a.id,lang:c,text:d,url:a.url,format:"dfxp"})}}catch(a){}});return b}},{key:"getSegments",value:function getSegments(a){var b=[],c=a.mediapackage.attachments.attachment;if(!(c instanceof Array)){c=c?[c]:[]}var d={};c.forEach(function(a){try{if("presentation/segment+preview+hires"==a.type){if(/time=T(\d+):(\d+):(\d+)/.test(a.ref)){b=60*(60*parseInt(RegExp.$1))+60*parseInt(RegExp.$2)+parseInt(RegExp.$3);if(!d[b]){d[b]={id:"frame_"+b,mimetype:a.mimetype,time:b,url:a.url,thumb:a.url}}d[b].url=a.url}}else if("presentation/segment+preview"==a.type){if(/time=T(\d+):(\d+):(\d+)/.test(a.ref)){var b=60*(60*parseInt(RegExp.$1))+60*parseInt(RegExp.$2)+parseInt(RegExp.$3);if(!d[b]){d[b]={id:"frame_"+b,mimetype:a.mimetype,time:b,url:a.url,thumb:a.url}}d[b].thumb=a.url}}}catch(a){}});Object.keys(d).forEach(function(a){b.push(d[a])});return b}},{key:"getPreviewImage",value:function getPreviewImage(a){var b,c,d,e=a.mediapackage.attachments.attachment;if(!(e instanceof Array)){e=e?[e]:[]}e.forEach(function(a){if("presenter/player+preview"==a.type){b=a.url}if("presentation/player+preview"==a.type){c=a.url}if(a.type.endsWith("/player+preview")){d=a.url}});return c||b||d}},{key:"convertToDataJson",value:function convertToDataJson(a){var b=this.getStreams(a),c=this.getCaptions(a),d=this.getSegments(a),e={metadata:{title:a.mediapackage.title,duration:a.mediapackage.duration/1e3,preview:this.getPreviewImage(a)},streams:b,frameList:d,captions:c};return e}}]);return c}()});
//# sourceMappingURL=opencast_to_paella_converter.min.js.map
